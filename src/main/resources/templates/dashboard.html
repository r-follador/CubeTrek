<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <link rel="icon" type="image/svg" href="/assets/logo.svg">
    <title>CubeTrek - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script><link href="../css/dashboard.css" rel="stylesheet">
    <script src='../js/maplibre-gl.js'></script>
    <link href='../css/maplibre-gl.css' rel='stylesheet'/>
    <style>
        .hover-row:hover {
            background-color: rgba(185, 211, 246, 0.32);
        }
    </style>
</head>
<body>
<header th:fragment="header" class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#"><img class="me-2" src="/assets/logo.svg" width="30">CubeTrek</a>
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="w-100"></div>
    <ul class="navbar-nav px-3">
        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
            <img src="../assets/cubetrek_settings.svg" height="20px"></a>
    </ul>
    <div class="navbar-nav">
        <div class="nav-item text-nowrap">
            <a class="nav-link px-3" href="#" th:href="@{/logout}">Sign out</a>
        </div>
    </div>
</header>

<div class="container-fluid">
    <div th:with="field='dashboard'" class="row">
        <nav th:fragment="navigation (field)" id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/dashboard" th:classappend="${field=='dashboard' ? 'active' : ''}">
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/activities" th:classappend="${field=='activitylist' ? 'active' : ''}">
                            Activity List
                        </a>
                    </li>
                </ul>

                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Your Profile</span>
                    <a class="link-secondary" href="#" aria-label="Add a new report">
                        <span data-feather="plus-circle"></span>
                    </a>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link" href="/upload" th:classappend="${field=='upload' ? 'active' : ''}">
                            Upload Activities
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profile" th:classappend="${field=='profile' ? 'active' : ''}">
                            Profile
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="row">
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
            </div>

            <div th:if="${totalActivities < 5}" class="card m-5" style="width: 18rem;">
                <div class="card-body">
                    <h5 class="card-title" th:if="${totalActivities == 0}">Your Profile is empty üòî</h5>
                    <h5 class="card-title" th:unless="${totalActivities == 0}">Your Profile is almost empty üòî</h5>
                    <p class="card-text">Add your Tracks to get started. Upload your files, link your Garmin and Polar account to automatically sync future activities.</p>
                    <a href="/upload" class="btn btn-primary m-1">Upload Activity Files</a>
                    <a href="/profile" class="btn btn-primary m-1">Link Accounts</a>
                </div>
            </div>

            <div th:if="${totalActivities >= 5}" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2">
                <div class="h4">
                    <span>Personal Heatmap</span>
                    <div class="btn-group">
                        <a class="btn btn-light btn-sm" id="heatmaptype" data-bs-toggle="dropdown" aria-expanded="false">
                        Distance per Day
                        </a>
                        <ul class="dropdown-menu">
                        <li><a class="dropdown-item" onclick="heatmapChange('distance')">Distance</a></li>
                        <li><a class="dropdown-item" onclick="heatmapChange('ascent')">Ascent</a></li>
                        <li><a class="dropdown-item" onclick="heatmapChange('number')">Number of Activities</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex-grow-1 p-0 m-0" id="graph" style="width:100%">
            </div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2">
                <h4 class="h4">Recent Activities</h4>
            </div>

            <div class="alert alert-danger" role="alert" id="errorbox" style="display:none;">
                Error fetching data
            </div>

            <table class="table">
                <thead>
                <tr>
                    <th></th>
                    <th> Date</th>
                    <th> Title </th>
                    <th> Duration</th>
                    <th> Ascent </th>
                    <th> Distance </th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
            <a href="/activities" th:if="${totalActivities > 10}" type="button" class="btn btn-outline-primary" th:text="'View '+ ${totalActivities} + ' Activities'">View All Activities</a>

            <div class="container" id="springer" style="display:none;">
                <div class ="row">
                    <div class="col-5"><div id="map2d" style="height: 200px; width: 100%; min-height: 150px; min-width: 150px;"></div></div>
                    <div class="col-5"><div id="inlinegraph" style="height: 200px; width: 100%; min-height: 150px; min-width: 150px;"></div></div>
                    <div class="col-2">
                        <div class="row"><a id="springerShow3D" class="btn btn-light" href="#">3D View</a></div>
                        <div class="row"><a id="springerShowMatching" class="btn btn-light mt-1" href="#">Matching activities</a></div>
                        <div class="row"><a id="springerEdit" class="btn btn-light mt-3" href="javascript:void(0);">Edit</a></div>
                    </div>
                </div>
            </div>


            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2">
                <h4 class="h4">Totals
                    <div class="btn-group">
                        <a class="btn btn-light btn-sm" id="barGraphButton" data-bs-toggle="dropdown" aria-expanded="false">
                            Activitytype
                        </a>
                        <ul class="dropdown-menu" id="barGraphDropdown">
                        </ul>
						<a class="btn btn-light btn-sm" id="barGraphButton2" data-bs-toggle="dropdown" aria-expanded="false">
                            Distance
                        </a>
                        <ul class="dropdown-menu" id="barGraphDropdown2">
							<li><a class="dropdown-item" onclick="updateBargraphType('distance')">Distance</a></li>
							<li><a class="dropdown-item" onclick="updateBargraphType('ascent')">Ascent</a></li>
                        </ul>
						<a class="btn btn-light btn-sm" id="barGraphButton3" onclick="updateBargraphTime()">
                            Monthly
                        </a>
                    </div>
                </h4>
            </div>

            <div class="flex-grow-1 p-0 m-0" id="bargraph" style="width:100%">
            </div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2">
                <h4 class="h4">Best Of</h4>
            </div>

            <div class="row">

                <div class="col-lg-4">
                    <h6 class="h6">Furthest Distances</h6>
                    <ul class="nav nav-tabs" id="TabFurthest" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="furthest-recent-tab" data-bs-toggle="tab" data-bs-target="#furthest-recent-pane" type="button" role="tab" aria-controls="furthest-recent-pane" aria-selected="true">Last 3 Month</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="furthest-alltime-tab" data-bs-toggle="tab" data-bs-target="#furthest-alltime-pane" type="button" role="tab" aria-controls="furthest-alltime-pane" aria-selected="false">All-Time</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="TabFurthestContent">
                        <div class="tab-pane fade" id="furthest-recent-pane" role="tabpanel" aria-labelledby="furthest-recent-tab" tabindex="0">
                            <table class="table">
                                <thead class="table-header">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Distance</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${topTracks.recentDistance.empty}">
                                    <td colspan="2"><i>No Activities</i></td>
                                </tr>
                                <tr th:each="track : ${topTracks.recentDistance}">
                                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                                             th:title="${track.activitytype.getDisplayValue()}"></td>
                                    <td><span th:data-date="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                                    <td><span th:data-longdist="${track.getDistance()}" th:text="${track.getDistance()}"> Distance </span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade show active" id="furthest-alltime-pane" role="tabpanel" aria-labelledby="furthest-alltime-tab" tabindex="0">
                            <table class="table">
                                <thead class="table-header">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Distance</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${topTracks.alltimeDistance.empty}">
                                    <td colspan="2"><i>No Activities</i></td>
                                </tr>
                                <tr th:each="track : ${topTracks.alltimeDistance}">
                                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                                             th:title="${track.activitytype.getDisplayValue()}"></td>
                                    <td><span th:data-date="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                                    <td><span th:data-longdist="${track.getDistance()}" th:text="${track.getDistance()}"> Distance </span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <h6 class="h6">Furthest Climbs</h6>
                    <ul class="nav nav-tabs" id="TabAscent" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ascent-recent-tab" data-bs-toggle="tab" data-bs-target="#ascent-recent-pane" type="button" role="tab" aria-controls="ascent-recent-pane" aria-selected="true">Last 3 Month</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ascent-alltime-tab" data-bs-toggle="tab" data-bs-target="#ascent-alltime-pane" type="button" role="tab" aria-controls="ascent-alltime-pane" aria-selected="false">All-Time</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="TabAscentContent">
                        <div class="tab-pane fade" id="ascent-recent-pane" role="tabpanel" aria-labelledby="ascent-recent-tab" tabindex="0">
                            <table class="table">
                                <thead class="table-header">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Ascent</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${topTracks.recentAscent.empty}">
                                    <td colspan="2"><i>No Activities</i></td>
                                </tr>
                                <tr th:each="track : ${topTracks.recentAscent}">
                                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                                             th:title="${track.activitytype.getDisplayValue()}"></td>
                                    <td><span th:data-date="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                                    <td><span th:data-shortdist="${track.getElevationup()}" th:text="${track.getElevationup()}"> Ascent </span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade  show active" id="ascent-alltime-pane" role="tabpanel" aria-labelledby="ascent-alltime-tab" tabindex="0">
                            <table class="table">
                                <thead class="table-header">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Ascent</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${topTracks.alltimeAscent.empty}">
                                    <td colspan="2"><i>No Activities</i></td>
                                </tr>
                                <tr th:each="track : ${topTracks.alltimeAscent}">
                                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                                             th:title="${track.activitytype.getDisplayValue()}"></td>
                                    <td><span th:data-date="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                                    <td><span th:data-shortdist="${track.getElevationup()}" th:text="${track.getElevationup()}"> Ascent </span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <h6 class="h6">Highest Peaks</h6>
                    <ul class="nav nav-tabs" id="TabPeaks" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="peaks-recent-tab" data-bs-toggle="tab" data-bs-target="#peaks-recent-pane" type="button" role="tab" aria-controls="peaks-recent-pane" aria-selected="true">Last 3 Month</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="peaks-alltime-tab" data-bs-toggle="tab" data-bs-target="#peaks-alltime-pane" type="button" role="tab" aria-controls="peaks-alltime-pane" aria-selected="false">All-Time</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="TabPeaksContent">
                        <div class="tab-pane fade" id="peaks-recent-pane" role="tabpanel" aria-labelledby="peaks-recent-tab" tabindex="0">
                            <table class="table">
                                <thead class="table-header">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Highest Point ASL</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${topTracks.recentPeak.empty}">
                                    <td colspan="2"><i>No Activities</i></td>
                                </tr>
                                <tr th:each="track : ${topTracks.recentPeak}">
                                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                                             th:title="${track.activitytype.getDisplayValue()}"></td>
                                    <td><span th:data-date="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                                    <td><span th:data-shortdist="${track.getHighestpoint()}" th:text="${track.getHighestpoint()}"> Highest Point </span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade  show active" id="peaks-alltime-pane" role="tabpanel" aria-labelledby="peaks-alltime-tab" tabindex="0">
                            <table class="table">
                                <thead class="table-header">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Highest Point ASL</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${topTracks.alltimePeak.empty}">
                                    <td colspan="2"><i>No Activities</i></td>
                                </tr>
                                <tr th:each="track : ${topTracks.alltimePeak}">
                                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                                             th:title="${track.activitytype.getDisplayValue()}"></td>
                                    <td><span th:data-date="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                                    <td><span th:data-shortdist="${track.getHighestpoint()}" th:text="${track.getHighestpoint()}"> Highest Point </span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2">
                <h4 class="h4"><img src='../assets/icon_favorite_select.svg' height='15px'> My Favorites <img src='../assets/icon_favorite_select.svg' height='15px'></h4>
            </div>

            <table class="table">
                <thead>
                <tr>
                    <th></th>
                    <th> Date </th>
                    <th> Title </th>
                    <th> Duration </th>
                    <th> Ascent</th>
                    <th> Distance</th>
                    <th> </th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${favoriteTracks.empty}">
                    <td colspan="2"><i>No favorite Activities, mark them by clicking the star ‚≠ê</i></td>
                </tr>
                <tr th:each="track : ${favoriteTracks}">
                    <td><img height="30px" th:src="${'../assets/'+track.activitytype.getIconName()}"
                             th:title="${track.activitytype.getDisplayValue()}"></td>
                    <td><span th:data-datetime="${track.getDatetrack()}" th:text="${track.getDatetrack()}"> Date </span></td>
                    <td><a th:href="'/view/'+${track.getId()}" th:text="${track.getTitle()}"> Title </a></td>
                    <td><span th:data-duration="${track.getDuration()}" th:text="${track.getDuration()}"> Duration </span></td>
                    <td><span th:data-shortdist="${track.getElevationup()}" th:text="${track.getElevationup()}"> Ascent </span></td>
                    <td><span th:data-longdist="${track.getDistance()}" th:text="${track.getDistance()}"> Distance </span></td>
                    <td><span th:if="${track.getTrackgroup() != null}"> <a th:href="'/matching/'+${track.getTrackgroup()}"><img src="/assets/matched.svg" title="Matching Activities"></a></span></td>
                </tr>
                </tbody>
            </table>

        </main>
    </div>
</div>
<div class="modal fade" id="settingsModal" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="metricChecked" onclick="clickSettingsMetric()">
                    <label class="form-check-label" for="metricChecked" id="metricCheckedLabel">Metric Units</label>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="heatmapModal" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="heatmapModalTitle">Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th></th>
                        <th> Date</th>
                        <th> Title </th>
                        <th> Duration</th>
                        <th> Ascent</th>
                        <th> Distance </th>
                    </tr>
                    </thead>
                    <tbody id="poptable">
                    </tbody>
                </table>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Track</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" style="display: none;" id="errormessageedit" role="alert">
                </div>
                <div class="alert alert-success" style="display: none;" id="successmessageedit" role="alert">
                </div>
                <form>
                    <div class="mb-3">
                        <label for="inputTitle" class="form-label">Track Title</label>
                        <input type="text" class="form-control" id="inputTitle"
                               maxlength="250">
                    </div>
                    <div class="mb-3">
                        <label for="inputType" class="form-label">Track Type</label>

                        <select class="form-select" id="inputType">
                            <option th:each="activityOpt : ${T(com.cubetrek.database.TrackData.Activitytype).values()}"
                                    th:value="${activityOpt}"
                                    th:text="${activityOpt.displayValue}"
                            ></option>
                        </select>
                    </div>
                    <h6 class="mt-3">Favorite</h6>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="favoriteChecked"
                               onclick="setFavorite()">
                        <label class="form-check-label" for="favoriteChecked" id="favoriteCheckedLabel">Favorite</label>
                    </div>
                    <h6 class="mt-3">Privacy</h6>
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" id="publicChecked"
                               onclick="setTrackShare()">
                        <label class="form-check-label" for="publicChecked" id="publicCheckedLabel">Public</label>
                    </div>
                    <h6 class="mt-3">Hide or Delete Track</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="clickhide(false)">Hide Track
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="clickdelete(false)">Delete Track
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>
</div>


<div class="modal" id="confirmhidden" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hide Track</h5>
            </div>
            <div class="modal-body">
                <p>Hiding a track will exclude it from the Dashboard and your totals.</p>
                <p>The only way to view hidden tracks later on is through the designated link on the dashboard.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).show();">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="clickhide(true)">Hide Track</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="confirmdelete" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Track</h5>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this Track?</p>
                <p>This cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).show();">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="clickdelete(true)">Delete Track</button>
            </div>
        </div>
    </div>
</div>
</body>

<script src="../js/d3.min.js"></script>
<script th:inline="javascript">
    var icons = {};
    /*[# th:each="activityOpt : ${T(com.cubetrek.database.TrackData.Activitytype).values()}"]*/
    icons[ /*[[${activityOpt}]]*/ ] =[ /*[[${activityOpt.iconName}]]*/ , /*[[${activityOpt.displayValue}]]*/ ];
    /*[/]*/

    var dataHeatmap = [(${activityHeatmapJSON})];

    var datamonthly = [(${monthlyTotalJSON})];

    var datayearly = [(${yearlyTotalJSON})];
</script>
<script th:inline="none">
    var parseDate = d3.utcParse("%Y-%m-%dT%H:%M:%S%Z");
    let metric = true;
    const miles_per_km = 0.621371;
    const feet_per_m = 3.28084;
    const datas = [];
    const bargraphdatasMonthly = [];
    const bargraphdatasYearly = [];

    const tablebody = document.getElementById("tbody");
    var entries = new Map();


    function prepareHeatmapdata() {
        for (var i=0; i<dataHeatmap.length; i++) {
            let date = parseDate(dataHeatmap[i].trackdata_day);
            date.setHours(12,0,0,0);
            let day_dist = (dataHeatmap[i].day_dist/1000);
            let day_elevationup = dataHeatmap[i].day_elevationup;
            let number = dataHeatmap[i].number;
            datas.push({'date' : date, 'day_dist' : day_dist, 'day_elevationup' : day_elevationup, 'number' : number});
        }

        var minDate = new Date(d3.min(datas, d => d.date));
        minDate.setMonth(0);
        minDate.setDate(1);
        var today = new Date();

        while (minDate <= today) {
            const found = datas.some(d => d.date.getTime() === minDate.getTime());
            if (!found) {
                datas.push({'date' : new Date(minDate)});
            }
            minDate.setDate(minDate.getDate() + 1);
        }
    }

    let bargraphType = "distance";
    let bargraphActivity = 2;
	let bargraphYearly = false;

	let barchart = [];

    function prepareBargraphdata() {
        for (var i=0; i<datamonthly.length; i++) {
            let date = parseDate(datamonthly[i].trackdata_month);
            date.setHours(12,0,0,0);
            let monthly_dist = (datamonthly[i].monthly_dist/1000);
            let activitytype = datamonthly[i].activitytype;
            bargraphdatasMonthly.push({'date' : date, 'monthly_dist' : monthly_dist, 'monthly_elevationup' : datamonthly[i].monthly_elevationup, 'activitytype' : activitytype});
        }

        for (var i=0; i<datayearly.length; i++) {
            let date = parseDate(datayearly[i].trackdata_year);
            date.setHours(12,0,0,0);
            let yearly_dist = (datayearly[i].yearly_dist/1000);
            let activitytype = datayearly[i].activitytype;
            bargraphdatasYearly.push({'date' : date, 'yearly_dist' : yearly_dist, 'yearly_elevationup' : datayearly[i].yearly_elevationup, 'activitytype' : activitytype});
        }

        const uniqueActivities = [...new Set(bargraphdatasMonthly.map(item => item.activitytype))];
        document.getElementById("barGraphButton").innerText = icons[Object.keys(icons)[uniqueActivities[0]]][1];
        bargraphActivity = uniqueActivities[0];
        for (let act of uniqueActivities) {
            var node = document.createElement("li");
            node.innerHTML = "<a class='dropdown-item' onclick='updateBargraphActivity("+act+")'>"+icons[Object.keys(icons)[act]][1]+"</a>";
            document.getElementById("barGraphDropdown").appendChild(node);
        }

        this.width = document.getElementById('bargraph').clientWidth*0.8;
        this.width = Math.max(500, this.width);
        d3.select("#bargraph").select("svg").remove(); //clear if exists already
        this.svg = d3.select("#bargraph").append("svg");
        barchart = BarChart(this.svg, bargraphdatasMonthly, bargraphdatasYearly, bargraphActivity);
    }

    function updateBargraphActivity(activity) {
		document.getElementById("barGraphButton").innerText = icons[Object.keys(icons)[activity]][1];
        bargraphActivity = activity;
        updateBargraph();
    }

    function updateBargraphType(type) {
		switch (type) {
			case "distance":
				document.getElementById("barGraphButton2").innerText = "Distance";
				break;
			case "ascent":
				document.getElementById("barGraphButton2").innerText = "Ascent";
				break;
		}
        bargraphType = type;
        updateBargraph();
    }

	function updateBargraphTime() {
		bargraphYearly = !bargraphYearly;
		document.getElementById("barGraphButton3").innerText = (bargraphYearly ? "Yearly" : "Monthly");
        updateBargraph();
    }

    function updateBargraph() {
		barchart.update(bargraphActivity, bargraphType, bargraphYearly);
    }

    let heatmapType = "distance";

    function drawHeatmap() {
        this.width = document.getElementById('graph').clientWidth*0.8;

        this.width = Math.max(500, this.width);

        d3.select("#graph").select("svg").remove(); //clear if exists already
        this.svg = d3.select("#graph").append("svg");

        Calendar(this.svg, datas, {
            x: d => d.date,
            y: d => {
                switch (heatmapType) {
                    case 'distance':
                        return d.day_dist;
                    case 'ascent':
                        return d.day_elevationup;
                    case 'number':
                        return d.number;
                }
            },
            width: this.width,
            cellSize: (this.width/60),
            weekday: "monday",
            colors: (function(){
                switch (heatmapType) {
                    case 'distance':
                        return d3.interpolateYlOrRd;
                    case 'ascent':
                        return d3.interpolateYlGn;
                    case 'number':
                        return d3.interpolateRdPu;
                }}()),
            formatingFunction: (function(){
                switch (heatmapType) {
                    case 'distance':
                        return formatLongdist;
                    case 'ascent':
                        return formatShortdist;
                    case 'number':
                        return formatNumberActivities;
                }}())
        });
    }

    function heatmapChange(type) {
        switch (type) {
            case 'distance':
                heatmapType = "distance";
                document.getElementById("heatmaptype").innerText = "Distance per Day";
                break;
            case 'ascent':
                heatmapType = "ascent";
                document.getElementById("heatmaptype").innerText = "Vertical Ascent per Day";
                break;
            case 'number':
                heatmapType = "number";
                document.getElementById("heatmaptype").innerText = "Number of Activities per Day";
                break;
        }
        drawHeatmap();
    }

    prepareHeatmapdata();
    prepareBargraphdata();
    settings();

    var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("background", "rgba(245, 245, 255, 0.6)");

    // Copyright 2021 Observable, Inc.
    // Released under the ISC license.
    // https://observablehq.com/@d3/calendar-view
    function Calendar(svg, data, {
        x = ([x]) => x, // given d in data, returns the (temporal) x-value
        y = ([, y]) => y, // given d in data, returns the (quantitative) y-value
        width = 1100, // width of the chart, in pixels
        cellSize = 20, // width and height of an individual day, in pixels
        weekday = "monday", // either: weekday, sunday, or monday
        formatDay = i => "SMTWTFS"[i], // given a day number in [0, 6], the day-of-week label
        formatMonth = "%b", // format specifier string for months (above the chart)
        formatingFunction = formatShortdist,
        colors = d3.interpolateYlOrRd
    } = {}) {
        // Compute values.
        const X = d3.map(data, x);
        const Y = d3.map(data, y);
        const I = d3.range(X.length);

        const countDay = weekday === "sunday" ? i => i : i => (i + 6) % 7;
        const timeWeek = weekday === "sunday" ? d3.utcSunday : d3.utcMonday;
        const weekDays = weekday === "weekday" ? 5 : 7;
        const height = cellSize * (weekDays + 2);

        // Compute a color scale. This assumes a diverging color scheme where the pivot
        // is zero, and we want symmetric difference around zero.
        const max = d3.quantile(Y, 0.9975, Math.abs);
        const color = d3.scaleSequential([0, max], colors).unknown("#eee");

        // Construct formats.
        formatMonth = d3.utcFormat(formatMonth);

        // Group the index by year, in reverse input order. (Assuming that the input is
        // chronological, this will show years in reverse chronological order.)
        const years = d3.groups(I, i => X[i].getUTCFullYear()).reverse();

        function pathMonth(t) {
            const d = Math.max(0, Math.min(weekDays, countDay(t.getUTCDay())));
            const w = timeWeek.count(d3.utcYear(t), t);
            return `${d === 0 ? `M${w * cellSize},0`
                : d === weekDays ? `M${(w + 1) * cellSize},0`
                    : `M${(w + 1) * cellSize},0V${d * cellSize}H${w * cellSize}`}V${weekDays * cellSize}`;
        }

        svg
            .attr("width", width)
            .attr("height", height * years.length)
            .attr("viewBox", [0, 0, width, height * years.length])
            .attr("style", "max-width: 100%; height: auto; height: intrinsic;")
            .attr("font-family", "var(--bs-body-font-family)")
            .attr("font-size", "0.7rem");

        const year = svg.selectAll("g")
            .data(years)
            .join("g")
            .attr("transform", (d, i) => `translate(40.5,${height * i + cellSize * 1.5})`);

        year.append("text")
            .attr("x", -5)
            .attr("y", -5)
            .attr("font-weight", "bold")
            .attr("text-anchor", "end")
            .text(([key]) => key);

        year.append("g")
            .attr("text-anchor", "end")
            .selectAll("text")
            .data(weekday === "weekday" ? d3.range(1, 6) : d3.range(7))
            .join("text")
            .attr("x", -5)
            .attr("y", i => (countDay(i) + 0.5) * cellSize)
            .attr("dy", "0.31em")
            .text(formatDay);

        const formatDate = d3.utcFormat("%B %-d, %Y");
        const formatValue = color.tickFormat(100, "1f");

        const cell = year.append("g")
            .selectAll("rect")
            .data(weekday === "weekday"
                ? ([, I]) => I.filter(i => ![0, 6].includes(X[i].getUTCDay()))
                : ([, I]) => I)
            .join("rect")
            .attr("width", cellSize - 1)
            .attr("height", cellSize - 1)
            .attr("x", i => timeWeek.count(d3.utcYear(X[i]), X[i]) * cellSize + 0.5)
            .attr("y", i => countDay(X[i].getUTCDay()) * cellSize + 0.5)
            .attr("fill", i => color(Y[i]))
            .on("mouseover", function(e, i) {
				let thisRect = d3.select(this);
                tooltip.style("visibility", "visible");
                tooltip.style("top", (e.pageY-10)+"px").style("left",(e.pageX+10)+"px");
                tooltip.html(formatDate(X[i])+"<br>"+(Y[i] === undefined?"<i>No Activity</i>":formatingFunction(Y[i])));
            })
            .on("mouseout", function(e, i) {
                tooltip.style("visibility", "hidden");
            })
            .on("click", function(e, i) {
                if (Y[i] !== undefined) {
                    clickDay(dataHeatmap[i].trackdata_day);
                }
            });

        const month = year.append("g")
            .selectAll("g")
            .data(([, I]) => d3.utcMonths(d3.utcMonth(X[I[0]]), X[I[I.length - 1]]))
            .join("g");

        month.filter((d, i) => i).append("path")
            .attr("fill", "none")
            .attr("stroke", "#fff")
            .attr("stroke-width", 3)
            .attr("d", pathMonth);

        month.append("text")
            .attr("x", d => timeWeek.count(d3.utcYear(d), timeWeek.ceil(d)) * cellSize + 2)
            .attr("y", -5)
            .text(formatMonth);

        return Object.assign(svg.node(), {scales: {color}});
    }

    const tablebodyPop = document.getElementById("poptable");

    function clickDay(date) {
        var dt = new Date(Date.parse(date));
        let year = dt.getUTCFullYear();
        let month = dt.getMonth();
        let day = dt.getDate();

        var url = "/activities_per_day?year="+year+"&month="+month+"&day="+day+"&timezone="+Intl.DateTimeFormat().resolvedOptions().timeZone;;

        fetch(url)
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    console.log("ERROR");
                    //ignore error
                }
            })
            .then(data => {
                while (tablebodyPop.firstChild) { //remove everything first
                    tablebodyPop.removeChild(tablebodyPop.firstChild);
                }
                document.getElementById('heatmapModalTitle').innerText=
                    (new Date(Date.parse(data[0].datetrack))).toLocaleString([], {year: 'numeric', month: 'long', day: 'numeric',  weekday: "long"});
                for (var entry of data) {
                    var row = tablebodyPop.insertRow();
                    row.insertCell().innerHTML = "<img src='../assets/"+icons[entry.activitytype][0]+"' alt='"+icons[entry.activitytype][1]+"' height=20px>";
                    row.insertCell().innerHTML = (new Date(Date.parse(entry.datetrack))).toLocaleString([], {hour: '2-digit', minute: '2-digit'});
                    row.insertCell().innerHTML = (entry.favorite?"<img src='../assets/icon_favorite_select.svg' height='15px'>":"") + "<a href='/view/"+entry.id+"'>"+entry.title+"</a>";
                    row.insertCell().innerHTML = minToString(parseInt(entry.duration))+ " h";
                    row.insertCell().innerHTML = (entry.elevationup*(metric?1:feet_per_m)).toFixed(0) + (metric?" m":" ft");
                    row.insertCell().innerHTML = (parseFloat(entry.distance)/1000*(metric?1:miles_per_km)).toFixed(1) + (metric?" km":" mi");
                }
                bootstrap.Modal.getOrCreateInstance(document.getElementById('heatmapModal')).show();
            });
    }

    function BarChart(svg, data_monthly, data_yearly, activitytype, {
        width = 1000,
        height = 300,
        marginTop = 30, // top margin, in pixels
        marginRight = 0, // right margin, in pixels
        marginBottom = 30, // bottom margin, in pixels
        marginLeft = 60, // left margin, in pixels
        xRange = [marginLeft, width - marginRight], // [xmin, xmax]
        yRange = [height - marginBottom, marginTop], // [ymin, ymax]
        yFormat, // a format specifier string for the y-axis
        duration: initialDuration = 250, // transition duration, in milliseconds
        delay: initialDelay = (_, i) => i * 20 // per-element transition delay, in milliseconds
    } = {}) {
        // Compute values.
        let X_monthly = d3.map(data_monthly.filter(d => d.activitytype === activitytype), d => d.date);
        let X_yearly = d3.map(data_yearly.filter(d => d.activitytype === activitytype), d => d.date);
        let Y = d3.map(data_monthly.filter(d => d.activitytype === activitytype), d => d.monthly_dist*(metric?1:miles_per_km));

        //xDomain
        let xDomain_monthly = new d3.InternSet(d3.map(data_monthly, d => d.date));
        const minDate = new Date(d3.min(xDomain_monthly));
		minDate.setMonth(0);
        const today = new Date();
		today.setMonth(11);
        xDomain_monthly = [];
        while (minDate <= today) {
            xDomain_monthly.push(new Date(minDate));
            minDate.setMonth(minDate.getMonth() + 1);
        }
		xDomain_monthly = [...new Set(xDomain_monthly)];

        let xDomain_yearly = new d3.InternSet(d3.map(data_yearly, d => d.date));
        const minDate_year = new Date(d3.min(xDomain_yearly));
        xDomain_yearly = [];
        while (minDate_year <= today) {
            xDomain_yearly.push(new Date(minDate_year));
            minDate_year.setFullYear(minDate_year.getFullYear() + 1);
        }
        xDomain_yearly = [...new Set(xDomain_yearly)];

		let yearDomain_monthly = new d3.InternSet(d3.map(xDomain_monthly, d => d.getFullYear()));
		let monthDomain_monthly = new d3.InternSet(d3.map(xDomain_monthly, d => d.getMonth()));

		const xScaleYear_monthly = d3.scaleBand().domain(yearDomain_monthly).range(xRange).paddingOuter(0).paddingInner(0.05);
		const xScaleMonth_monthly = d3.scaleBand().domain(monthDomain_monthly).range([0, xScaleYear_monthly.bandwidth()]).padding(0.05);

        let yearDomain_yearly = new d3.InternSet(d3.map(xDomain_yearly, d => d.getFullYear()));
        const xScaleYear_yearly = d3.scaleBand().domain(yearDomain_yearly).range(xRange).paddingOuter(0).paddingInner(0.05);


        //yDomain
        let yDomain = [0, d3.max(Y)];

        // Construct scales, axes, and formats.
        let yScale = d3.scaleLinear(yDomain, yRange);
        let yAxis = d3.axisLeft(yScale).ticks(height / 40, yFormat);

        svg
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [0, 0, width, height])
            .attr("style", "max-width: 100%; height: auto; height: intrinsic;")
            .on("click", function(e, i) {
                updateBargraphTime();
            });

        const yGroup = svg.append("g")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(yAxis)
            .call(g => g.select(".domain").remove())
            .call(g => g.selectAll(".tick").call(grid))
            .call(g => g.append("text")
				.attr("id", "bargraphhead")
                .attr("x", -marginLeft)
                .attr("y", 10)
                .attr("fill", "black")
                .attr("text-anchor", "start")
                .text("‚Üë Distance ["+(metric?"km":"mi")+"]"));

		let xcolorsMonthly = d3.scaleOrdinal(xDomain_monthly, colors = d3.quantize(d3.interpolateHcl("#fafa6e", "#2A4858"), 12));
		let xcolorsYearly = d3.scaleOrdinal(xDomain_yearly, colors = d3.quantize(d3.interpolateHcl("#fafa6e", "#2A4858"), 12));

		var formatDate = d3.timeFormat("%B %Y");

        const rect_monthly = svg.append("g")
            .selectAll("rect")
            .data(xDomain_monthly)
            .join("rect")
			.each(function(d, i) {
				position_monthly(d3.select(this), d, "distance");
			}).attr("fill", i => xcolorsMonthly(i))
			.style("mix-blend-mode", "multiply");

        const rect_yearly = svg.append("g")
            .selectAll("rect")
            .data(xDomain_yearly)
            .join("rect")
            .each(function(d, i) {
                position_yearly(d3.select(this), d, "distance");
            }).attr("fill", i => xcolorsYearly(i))
            .style("mix-blend-mode", "multiply")
            .style("visibility", "hidden");

		const monthAxis = svg.append("g");

		for (let year of yearDomain_monthly) {
			const xAxis = d3.axisBottom(xScaleMonth_monthly).tickSize(0)
				.tickFormat(d => d3.timeFormat("%b")((new Date()).setMonth(d)));
			monthAxis.append("g")
				.attr("transform", `translate(${xScaleYear_monthly(year)},${13+height - marginBottom})`)
				.call(xAxis).call(g => g.select(".domain").remove());
		}

		const xAxis_year_monthly = d3.axisBottom(xScaleYear_monthly).tickSize(0);
        const xAxis_year_yearly = d3.axisBottom(xScaleYear_yearly).tickSize(0);
		const yearaxis = svg.append("g")
				.attr("transform", `translate(0,${height - marginBottom})`)
				.call(xAxis_year_monthly);

        // A helper method for updating the position of bars.
        function position_monthly(rect, xdomaindate, measuretype) {
			let index = X_monthly.findIndex(element => element.getTime() === xdomaindate.getTime());
			let y = 0;
			if (index !== -1) {
				y = yScale(Y[index]);
			} else {
				y = yScale(0);
			}
			return rect
				.attr("width", xScaleMonth_monthly.bandwidth())
				.on("mouseover", function(e, i) {
					if (index < 0)
						return;

					tooltip.style("visibility", "visible");
					tooltip.style("top", (e.pageY-10)+"px").style("left",(e.pageX+10)+"px");

					switch (measuretype) {
					case 'distance':
						tooltip.html(Y[index].toFixed(1) + (metric?" km":" mi")+"<br>"+formatDate(X_monthly[index]));
						break;
					case 'ascent':
						tooltip.html(Y[index].toFixed(0) + (metric?" m":" ft")+"<br>"+formatDate(X_monthly[index]));
						break;
					}
				})
				.on("mouseout", function(e, i) {
					tooltip.style("visibility", "hidden");
				})
				.attr("x", xScaleYear_monthly(xdomaindate.getFullYear())+xScaleMonth_monthly(xdomaindate.getMonth()))
                .attr("width", xScaleMonth_monthly.bandwidth())
                .transition()
                .attr("y", y)
				.attr("height", yScale(0) - y);
        }

        function position_yearly(rect, xdomaindate, measuretype) {
            let index = X_yearly.findIndex(element => element.getTime() === xdomaindate.getTime());
            let y = 0;
            if (index !== -1) {
                y = yScale(Y[index]);
            } else {
                y = yScale(0);
            }
            return rect
                .attr("width", xScaleYear_yearly.bandwidth())
                .on("mouseover", function(e, i) {
                    if (index < 0)
                        return;

                    tooltip.style("visibility", "visible");
                    tooltip.style("top", (e.pageY-10)+"px").style("left",(e.pageX+10)+"px");

                    switch (measuretype) {
                        case 'distance':
                            tooltip.html(Y[index].toFixed(1) + (metric?" km":" mi")+"<br>"+X_yearly[index].getFullYear());
                            break;
                        case 'ascent':
                            tooltip.html(Y[index].toFixed(0) + (metric?" m":" ft")+"<br>"+X_yearly[index].getFullYear());
                            break;
                    }
                })
                .on("mouseout", function(e, i) {
                    tooltip.style("visibility", "hidden");
                })
                .attr("x", xScaleYear_yearly(xdomaindate.getFullYear()))
                .attr("width", xScaleYear_yearly.bandwidth())
                .transition()
                .attr("y", y)
                .attr("height", yScale(0) - y);
        }

        // A helper method for generating grid lines on the y-axis.
        function grid(tick) {
			tick.selectAll("line").remove();
            return tick.append("line")
                .attr("class", "grid")
                .attr("x2", width - marginLeft - marginRight)
                .attr("stroke", "black")
                .attr("stroke-opacity", 0.1);
        }

        // Call chart.update(activitytype, measuretype, yearlySum) to transition to new data.
        return Object.assign(svg.node(), {
            update(activitytype, measuretype, yearlySum) {

                if (yearlySum) {
                    X_yearly = d3.map(data_yearly.filter(d => d.activitytype === activitytype), d => d.date);
                    switch (measuretype) {
                        case 'distance':
                            Y = d3.map(data_yearly.filter(d => d.activitytype === activitytype), d => d.yearly_dist*(metric?1:miles_per_km));
                            document.getElementById("bargraphhead").innerHTML = "‚Üë Distance ["+(metric?"km":"mi")+"]";
                            break;
                        case 'ascent':
                            Y = d3.map(data_yearly.filter(d => d.activitytype === activitytype), d => d.yearly_elevationup*(metric?1:feet_per_m));
                            document.getElementById("bargraphhead").innerHTML = "‚Üë Vertical Ascent ["+(metric?"m":"ft")+"]";
                            break;
                    }
                    yearaxis.transition().call(xAxis_year_yearly);
                    monthAxis.style("visibility", "hidden");
                } else {
                    X_monthly = d3.map(data_monthly.filter(d => d.activitytype === activitytype), d => d.date);
                    switch (measuretype) {
                        case 'distance':
                            Y = d3.map(data_monthly.filter(d => d.activitytype === activitytype), d => d.monthly_dist*(metric?1:miles_per_km));
                            document.getElementById("bargraphhead").innerHTML = "‚Üë Distance ["+(metric?"km":"mi")+"]";
                            break;
                        case 'ascent':
                            Y = d3.map(data_monthly.filter(d => d.activitytype === activitytype), d => d.monthly_elevationup*(metric?1:feet_per_m));
                            document.getElementById("bargraphhead").innerHTML = "‚Üë Vertical Ascent ["+(metric?"m":"ft")+"]";
                            break;
                    }
                    yearaxis.transition().call(xAxis_year_monthly);
                    monthAxis.style("visibility", "visible");
                }

                yDomain = [0, d3.max(Y)];
                yScale = d3.scaleLinear(yDomain, yRange);
                yAxis = d3.axisLeft(yScale).ticks(height / 40, yFormat);

                yGroup.transition().call(yAxis);
                yGroup.call(g => g.selectAll(".tick").call(grid));

                if (yearlySum) {
                    rect_yearly
                        .style("visibility", "visible")
                        //.transition().duration(500).style("opacity", 1)
                        .each(function(d, i) {
                        position_yearly(d3.select(this), d, measuretype);
                        d3.select(this).attr("fill", i => {return xcolorsYearly(i)});
                        });

                    rect_monthly.style("visibility","hidden");
                } else {
                    rect_monthly.style("visibility", "visible")
                        //.transition().duration(500).style("opacity", 1)
                        .each(function(d, i) {
                        position_monthly(d3.select(this), d, measuretype);
                        d3.select(this).attr("fill", i => {return xcolorsMonthly(i)});
                        });

                    rect_yearly.style("visibility","hidden");
                }
            }
        });
    }

    function settings() {
        if (localStorage.getItem("metric") === null) {
            localStorage.setItem("metric", true);
        } else {
            metric = (localStorage.getItem("metric")==="true");
        }

        if (metric) {
            document.getElementById("metricChecked").checked = true;
            setMetric();
        } else {
            document.getElementById("metricChecked").checked = false;
            setMetric();
        }
    }

    function clickSettingsMetric() {
        metric = document.getElementById("metricChecked").checked;
        localStorage.setItem("metric",metric);
        setMetric();
    }

    function setMetric() {
        document.getElementById("metricCheckedLabel").innerText=(metric?"Metric Units":"Imperial Units");
        drawHeatmap();
        updateBargraph('distance', 'Running');
        formatValues();
        fetchData();
    }

    function minToString(minutes) {
        var m = minutes % 60;
        var h = (minutes-m)/60;
        return h.toString() + ":" + (m<10?"0":"") + m.toString();
    }

    function formatShortdist(value) {
        return (value *(metric?1:feet_per_m)).toFixed(0)+" "+(metric?"m":"ft");
    }

    function formatNumberActivities(value) {
        return value+" " + (value>1?"Activities":"Activity");
    }


    function formatLongdist(value) {
        return (value *(metric?1:miles_per_km)).toFixed(1)+" "+(metric?"km":"mi");
    }

    function formatValues() {
        document.querySelectorAll('[data-duration]').forEach(function(element) {
            element.innerText = minToString(element.dataset.duration)+" h";
        });

        document.querySelectorAll('[data-datetime]').forEach(function(element) {
            element.innerText = (new Date(Date.parse(element.dataset.datetime))).toLocaleString([], {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'});
        });

        document.querySelectorAll('[data-date]').forEach(function(element) {
            element.innerText = (new Date(Date.parse(element.dataset.date))).toLocaleString([], {year: 'numeric', month: 'numeric', day: 'numeric'});
        });

        document.querySelectorAll('[data-shortdist]').forEach(function(element) {
            element.innerText = formatShortdist(element.dataset.shortdist);
        });

        document.querySelectorAll('[data-longdist]').forEach(function(element) {
            element.innerText = formatLongdist(element.dataset.longdist/1000);
        });
    }

    window.addEventListener("resize", function () {
        drawHeatmap();
        updateBargraph('distance', 'Running');
    });

    function fetchData() {
        entries = new Map();
        while (tablebody.firstChild) {
            tablebody.removeChild(tablebody.firstChild);
        }
        const entriesPerFetch = 10;
        var url = "/activities_ajax?page=0&size="+entriesPerFetch+"&sortby=datetrack&descending=true";

        fetch(url)
            .then(response => {100
                if (response.status === 200) {
                    return response.json();
                } else {
                    document.getElementById("errorbox").style.display = 'block';
                }
            })
            .then(data => listData(data));
    }

    function listData(data) {
        for (var entry of data) {
            entries.set(entry.id, entry);
            var newRow = tablebody.insertRow();
            newRow.id="r"+entry.id;
            newRow.classList.add("hover-row");
            addRowInfo(newRow, entry);
        }
        openPane(data[0].id);
    }

    function addRowInfo(row, entry) {
        row.setAttribute("onclick","openPane("+entry.id+");");
        row.insertCell().innerHTML = "<img src='../assets/"+icons[entry.activitytype][0]+"' alt='"+icons[entry.activitytype][1]+"' height=20px>";
        row.insertCell().innerHTML = (new Date(Date.parse(entry.datetrack))).toLocaleString();
        row.insertCell().innerHTML = (entry.favorite?"<img src='../assets/icon_favorite_select.svg' height='15px'>":"") + "<a href='/view/"+entry.id+"'>"+entry.title+"</a>";
        row.insertCell().innerHTML = minToString(parseInt(entry.duration))+ " h";
        row.insertCell().innerHTML = (entry.elevationup*(metric?1:feet_per_m)).toFixed(0) + (metric?" m":" ft");
        row.insertCell().innerHTML = (parseFloat(entry.distance)/1000*(metric?1:miles_per_km)).toFixed(1) + (metric?" km":" mi");
        row.insertCell().innerHTML = (entry.trackgroup?"<a href='/matching/"+entry.trackgroup+"'><img title='Matching Activities' src='/assets/matched.svg'></a>":"");
    }

    var menu = function(id) {
        document.getElementById("successmessageedit").style.display = "none";
        selectedtrackid = id;
        var entry = entries.get(id);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).show();
        document.getElementById("inputTitle").value = (new DOMParser().parseFromString(entry.title, "text/html")).documentElement.textContent ;
        document.getElementById("inputType").value = entry.activitytype;
        document.getElementById("favoriteChecked").checked = entry.favorite;

        if (entry.favorite) {
            document.getElementById("favoriteChecked").checked = true;
            document.getElementById("favoriteCheckedLabel").innerText = "Favorite";
        } else {
            document.getElementById("favoriteChecked").checked = false;
            document.getElementById("favoriteCheckedLabel").innerText = "Not in your Favorites List";
        }

        if (entry.sharing === "PUBLIC") {
            document.getElementById("publicChecked").checked = true;
            document.getElementById("publicCheckedLabel").innerText = "Public, anyone with the link can view this track";
        } else {
            document.getElementById("publicChecked").checked = false;
            document.getElementById("publicCheckedLabel").innerText = "Private, only you can view this track";
        }
    }

    const root = "../api/";

    function clickdelete(confirmed) {
        if (!confirmed) {
            bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmdelete')).show();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).hide();
            return;
        }
        fetch(root + "modify/id=" + selectedtrackid, {
            method: "DELETE"
        }).then(res => {
            res.json().then(response => {
                if (res.ok) {
                    deleteRow(selectedtrackid);
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmdelete')).hide();
                } else {
                    //not good
                }
            });
        }).catch(error => {
            console.log("--error");
            console.log(error);
        });
    }

    function clickhide(confirmed) {
        if (!confirmed) {
            bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmhidden')).show();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).hide();
            return;
        }
        fetch(root+"modify/id="+selectedtrackid+"&hidden=true", {
            method: "GET"
        }).then(res => {
            res.json().then(response => {
                if (res.ok) {
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmhidden')).hide();
                    deleteRow(selectedtrackid);
                } else {
                    //not good
                }
            });
        }).catch(error => {
            console.log("--error");
            console.log(error);
        });
    }

    function setFavorite() {
        document.getElementById("favoriteChecked")

        if (document.getElementById("favoriteChecked").checked) {
            document.getElementById("favoriteCheckedLabel").innerText = "Favorite";
        } else {
            document.getElementById("favoriteCheckedLabel").innerText = "Not in your Favorites List";
        }
    }

    function setTrackShare() {
        document.getElementById("publicChecked")

        if (!document.getElementById("publicChecked").checked) {
            document.getElementById("publicCheckedLabel").innerText = "Private, only you can view this track";
        } else {
            document.getElementById("publicCheckedLabel").innerText = "Public, anyone with the link can view this track";
        }
    }

    document.getElementById("inputTitle").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            event.stopPropagation()
            event.stopImmediatePropagation();
            saveEdit();
        }
    });

    function saveEdit() {
        let currentEntry = entries.get(selectedtrackid);
        let editTitle = document.getElementById("inputTitle").value;
        let editType = document.getElementById("inputType").value;
        let editFavorite = document.getElementById("favoriteChecked").checked;
        let editShared = (document.getElementById("publicChecked").checked ? "PUBLIC" : "PRIVATE");

        if (editTitle !== currentEntry.title || editType !== currentEntry.activitytype ) {
            let data = {index: selectedtrackid, title: editTitle, activitytype: editType};

            fetch(root+"modify", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(res => {
                res.json().then(response => {
                    if (res.ok) {
                        document.getElementById("successmessageedit").innerText = "Changes saved";
                        document.getElementById("successmessageedit").style.display = "block";
                    } else {
                        document.getElementById("errormessageedit").innerText = response.response;
                        document.getElementById("errormessageedit").style.display = "block";
                    }
                });
            }).catch(error => {
                console.log("--error");
                console.log(error);
            });
        }

        if (editFavorite !== currentEntry.favorite) {
            fetch(root+"modify/id="+selectedtrackid+"&favorite="+(editFavorite), {
                method: "GET"
            }).then(res => {
                res.json().then(response => {
                    if (res.ok) {

                    } else {
                        //not good
                    }
                });
            }).catch(error => {
                console.log("--error");
                console.log(error);
            });
        }

        if (editShared !== currentEntry.sharing) {
            fetch(root+"modify/id="+selectedtrackid+"&sharing="+editShared, {
                method: "GET"
            }).then(res => {
                res.json().then(response => {
                    if (res.ok) {

                    } else {
                        //not good
                    }
                });
            }).catch(error => {
                console.log("--error");
                console.log(error);
            });
        }

        entries.get(selectedtrackid).title = editTitle;
        entries.get(selectedtrackid).activitytype = editType;
        entries.get(selectedtrackid).favorite = editFavorite;
        entries.get(selectedtrackid).sharing = editShared;

        var row = document.getElementById("r"+selectedtrackid);
        row.innerHTML="";
        addRowInfo(row, entries.get(selectedtrackid));
        bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).hide();
    }

    async function deleteRow(rowid)
    {
        var row = document.getElementById("r"+rowid);
        row.style.transition = '0.8s';
        row.style.opacity = 0;
        await new Promise(resolve => setTimeout(resolve, 1000));
        row.parentNode.removeChild(row);
    }


    var springerElement = document.getElementById("springer");
    var lastclicked = -1;
    function openPane(entryid) {
        if (lastclicked === entryid) { //already open
            springerElement.style.display = "none";
            document.getElementById("springerRow").remove();
            lastclicked = -1;
            return;
        }
        lastclicked = entryid;
        if (document.getElementById("springerRow"))
            document.getElementById("springerRow").remove();
        const newTr = document.createElement("tr"); newTr.setAttribute("id","springerRow");
        const newTd = document.createElement("td"); newTd.setAttribute("colspan", 7);
        newTd.appendChild(springerElement);
        newTr.appendChild(newTd);

        var row = document.getElementById("r"+entryid);
        springerElement.style.display = "block";
        row.parentNode.insertBefore(newTr, row.nextSibling);
        fetchgeojson(entryid);
        document.getElementById("springerEdit").addEventListener("click", function(){menu(entryid);});
        document.getElementById("springerShow3D").href="/view/"+entryid;

        if (entries.get(entryid).trackgroup) {
            document.getElementById("springerShowMatching").href="/matching/"+entries.get(entryid).trackgroup;
            document.getElementById("springerShowMatching").style.display = "block";
        } else {
            document.getElementById("springerShowMatching").style.display = "none";
        }

    }


    function fetchgeojson(trackid) {
        var url = "/api/geojson/"+trackid+".geojson";
        fetch(url)
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    document.getElementById("errorbox").style.display = 'block';
                }
            })
            .then(geojson => {prepareMap2d(geojson, map_firstload);drawInlineGraph(geojson);});
    }

    var map;
    var map_firstload = true;

    function prepareMap2d(jsonData, map_firstload) {
        if (map_firstload) {
            map_firstload = false;
            map = new maplibregl.Map({
                container: 'map2d',
                style: {
                    'version': 8,
                    'sources': {
                        'raster-tiles': {
                            'type': 'raster',
                            'tiles': [
                                'https://api.maptiler.com/maps/ch-swisstopo-lbm/256/{z}/{x}/{y}.png?key=Nq5vDCKAnSrurDLNgtSI '
                            ],
                            'tileSize': 256,
                        }
                    },
                    'layers': [
                        {
                            'id': 'simple-tiles',
                            'type': 'raster',
                            'source': 'raster-tiles',
                            'minzoom': 0,
                            'maxzoom': 22
                        }
                    ]
                },
                bounds: [[jsonData.properties.bbox.boundingBoxW - 0.005, jsonData.properties.bbox.boundingBoxS - 0.005], [jsonData.properties.bbox.boundingBoxE + 0.005, jsonData.properties.bbox.boundingBoxN + 0.005]],
                touchPitch: false,
                maxPitch: 0,
                minZoom: 0,
                maxZoom: 13,
                attributionControl: false
            });


            map.on('load', function () {
                map.addSource('route', {
                        type: 'geojson',
                        data: jsonData
                    }
                );
                map.addLayer({
                    'id': 'route',
                    'type': 'line',
                    'source': 'route',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#ff8001',
                        'line-width': 3
                    }
                });
            });
        } else {
            map.getSource('route').setData({
                    type: 'geojson',
                    data: jsonData
                }
            );
            map.fitBounds([[jsonData.properties.bbox.boundingBoxW - 0.005, jsonData.properties.bbox.boundingBoxS - 0.005], [jsonData.properties.bbox.boundingBoxE + 0.005, jsonData.properties.bbox.boundingBoxN + 0.005]]);

        }
    }


    function drawInlineGraph(jsonData) {
        var datas = [];
        let previousDistance = jsonData.geometry.coordinates[0][0][4];
        let previousElevation = jsonData.geometry.coordinates[0][0][2];

        for (var i=0; i<jsonData.geometry.coordinates[0].length; i++) {
            let elevation = jsonData.geometry.coordinates[0][i][2];
            let distance = jsonData.geometry.coordinates[0][i][4];

            previousElevation = elevation;
            previousDistance = distance;
            datas.push({'altitude' : elevation, 'distance' : distance});
        }

        this.margingraph = {top: 10, right: 5, bottom: 25, left: 40};

        this.width = document.getElementById('inlinegraph').clientWidth-this.margingraph.left-this.margingraph.right,
            this.height = document.getElementById('inlinegraph').clientHeight-this.margingraph.top-this.margingraph.bottom;

        d3.select("#inlinegraph").select("svg").remove(); //clear if exists already
        this.svg = d3.select("#inlinegraph")
            .append("svg")
            .attr("width", this.width + this.margingraph.left + this.margingraph.right)
            .attr("height", this.height + this.margingraph.top + this.margingraph.bottom)
            .append("g")
            .attr("transform",
                "translate(" + this.margingraph.left + "," + this.margingraph.top + ")");

        this.yScale;
        this.xScale;
        this.functionpath = d3.line();

        this.yScale = d3.scaleLinear().domain(d3.extent(datas, function(d) { return (d.altitude*(metric?1:feet_per_m)); }));
        this.functionpath.y((d) => { return this.yScale(d.altitude*(metric?1:feet_per_m)) });

        this.xScale = d3.scaleLinear().domain(d3.extent(datas, function(d) { return (d.distance*(metric?1/1000:miles_per_km/1000)); }));
        this.functionpath.x((d) => { return this.xScale(d.distance*(metric?1/1000:miles_per_km/1000)) });

        this.xAxisLabel = d3.axisBottom(this.xScale);
        this.yAxisLabel = d3.axisLeft(this.yScale);

        this.yScale.range([this.height,0]);
        this.xScale.range([0, this.width]);

        this.svg.append("g")
            .attr("transform", "translate(0," + this.height + ")")
            .attr("class","myXaxis")
            .call(this.xAxisLabel);

        this.svg.append("g")
            .attr("class","myYaxis")
            .call(this.yAxisLabel);

        this.svg.append("path")
            .datum(datas)
            .attr("fill", "none")
            .attr("stroke", "#ff8001")
            .attr("stroke-width", 2)
            .attr("class", "datapath")
            .attr("d", this.functionpath)
    }


</script>

</html>